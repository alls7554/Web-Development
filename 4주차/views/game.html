<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>

    <!-- Latest compiled and minified CSS -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha384-HSMxcRTRxnN+Bdg0JdbxYKrThecOKuH5zCYotlSAcp1+c8xmyTe9GYg1l9a69psu" crossorigin="anonymous">
    
    <!-- Optional theme -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap-theme.min.css" integrity="sha384-6pzBo3FDv/PJ8r2KRkGHifhEocL+1X2rVCTTkUfGk7/0pbek5mMa1upzvWbrUbOZ" crossorigin="anonymous">
    
    <!-- Latest compiled and minified JavaScript -->
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha384-aJ21OjlMXNL5UyIl/XNwTMqvzeRMZH2w8c5cRVpzpU8Y5bApTppSuUkhZXN0VxHd" crossorigin="anonymous"></script>
    
    <script src="https://kit.fontawesome.com/94f5e1f0d5.js" crossorigin="anonymous"></script>
    
    <script src="/socket.io/socket.io.js"></script>

    <script src="js/game.js"></script>
    <script src="js/cookie.js"></script>
       
    <link rel="stylesheet" href="css/default.css">
    <link rel="stylesheet" href="css/chat.css">
    <link rel="stylesheet" href="css/game.css">
       
    <title>Bingo</title>
</head>
<body>
    <div class="jumbotron">
        <div class="container">
            <div class="row">
                <div class="row">
                    <div class="col-md-4 col-md-offset-4 title">
                        <h1>B I N G O !</h1>
                    </div>
                </div>
                <div class="row">
                    <div class="loader"></div>
                    <div class="col-md-9 main">
                        <div class='row'>
                            <div class="info_header col-md-12 ">
                                <div class='col-md-4'>
                                    <span>유저 이름 : </span>
                                    <span id="my_name"></span>
                                </div>
                                <div class='col-md-4'>
                                    <span>빙고 : </span>
                                    <span id="bingoCount">0</span>
                                </div>
                                <div class='col-md-4'>
                                    <span>현재 차례 : </span>
                                    <span id="user_turn"></span>
                                </div>
                            </div>
                        </div>

                        <div class='row'>
                            <div class='col-md-12'>
                                <table class="table table-bordered">
                                    <tr id="row_1">
                                        <td id="0" class="num"></td>
                                        <td id="1" class="num"></td>
                                        <td id="2" class="num"></td>
                                        <td id="3" class="num"></td>
                                        <td id="4" class="num"></td>
                                    </tr>
                                    <tr id="row_2">
                                        <td id="5" class="num"></td>
                                        <td id="6" class="num"></td>
                                        <td id="7" class="num"></td>
                                        <td id="8" class="num"></td>
                                        <td id="9" class="num"></td>
                                    </tr>
                                    <tr id="row_3">
                                        <td id="10" class="num"></td>
                                        <td id="11" class="num"></td>
                                        <td id="12" class="num"></td>
                                        <td id="13" class="num"></td>
                                        <td id="14" class="num"></td>
                                    </tr>
                                    <tr id="row_4">
                                        <td id="15" class="num"></td>
                                        <td id="16" class="num"></td>
                                        <td id="17" class="num"></td>
                                        <td id="18" class="num"></td>
                                        <td id="19" class="num"></td>
                                    </tr>
                                    <tr id="row_5">
                                        <td id="20" class="num"></td>
                                        <td id="21" class="num"></td>
                                        <td id="22" class="num"></td>
                                        <td id="23" class="num"></td>
                                        <td id="24" class="num"></td>
                                    </tr>
                                </table>
                            </div>
                        </div>

                        <!-- Modal -->
                        <div class="modal fade" id="result_modal" role="dialog">
                            <div class="modal-dialog">
                                <!-- Modal content-->
                                <div class="modal-content">
                                    <div class="modal-header">
                                        <h4 id="result" class="modal-title"></h4>
                                    </div>
                                    <div class="modal-body">
                                        <span id="winner"></span>
                                        <p>{사용자 이름}</p>
                                        <p>{사용자 이름}</p>
                                        <p>{사용자 이름}</p>
                                    </div>
                                    <div class="modal-footer">
                                        <a href="/game.html">
                                            <button type="button" class="btn btn-primary">다시하기</button>
                                        </a>
                                        <a href="/">
                                            <button type="button" id="exit_btn" class="btn btn-danger">나가기</button>
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </div> <!-- Model End-->
                    </div> 
                    <div class='col-md-3 chat'>
                        <div class='row chat_log'>
                            <ul id="chat_list" class='list-group'>
                                <!-- chat log -->
                            </ul>
                        </div>
                        <div class='row'>
                            <div class="col-md-12 input-group input_chat">
                                <div class="col-md-12 publisher bt-1 border-light"> 
                                    <input class="publisher-input" id="msg" type="text" placeholder="Write something">
                                    <button id="send_btn" class="publisher-btn text-info" href="#" data-abc="true">
                                        <i class="fa fa-paper-plane"></i>
                                    </button> 
                                </div>
                            </div>
                        </div>
                    </div>              
                </div>
            </div>
        </div>
    </div>
</body>
<script> 
    
    window.addEventListener('DOMContentLoaded', function(){
        const nickname = getCookie();
        
        if(nickname == ""){
            alert("Nickname이 없으므로 초기화면으로 돌아갑니다.")
            location.href = './';
        } 
        doc.getElementById('my_name').innerHTML = nickname;
    });

    const user_name = getCookie();
    const bingoRoom = io('/bingo');

    let roomIdx;
         
    let nums = doc.getElementsByClassName('num');
    
    for (let i = 0; i < nums.length; i++) {
        nums[i].addEventListener('click', function(){
            check_num(user_name, this);
            let num = this.innerHTML
            bingoRoom.emit('CLICK', { roomIdx, user_name, num} );
        });
    }

    let exit = doc.getElementById("exit_btn");
    exit.addEventListener('click', function(){
        deleteCookie();
    });

    bingoRoom.on('whosEnter', function(name, idx){
        $('#chat_list').append("<li class='list-group-item list-group-item-warning'><span>System : "+ name + "님이" + idx + "에 입장하셨습니다.</span></li>");
        $('#msg').focus();
        roomIdx = idx;
    });

    bingoRoom.on('GameStart',function() {
        for (let i = 0; i < arr.length; i++) {
            arr[i] = i + 1;
        }

        arr.sort(function () { return 0.5 - Math.random() });

        for (let i = 0; i < arr.length; i++) {
            bingo[i % 5] = arr[i];    //01234/01234/01234/01234/01234
            if ((i + 1) % 5 == 0) {
                arr2[tmp] = bingo;
                tmp++;
                bingo = [];
            }
        }

        let output = "";

        for (var i = 0; i < arr.length; i++) {

            output = "";
            output += arr[i];
            doc.getElementById(i).innerHTML += output;
        }
    });

    bingoRoom.on('CLICK', function(user_name, number) {
        for(let i=0; i<arr.length; i++){
            if(number == arr[i]) {
                            
                $("#chat_list").append("<li class='list-group-item list-group-item-warning'><span>System : "+ user_name + "님이 " + number +"을(를) 선택하셨습니다.</span></li>");
                console.log(arr2[parseInt(i / 5)][i % 5]);
                arr2[parseInt(i / 5)][i % 5] = 0;
                let clickedNum = document.getElementById(i)
                clickedNum.className += ' clicked_num';
            
                BlackBingo();
                return;
            }
        }
    });

    bingoRoom.on('GAMEOVER', function(){
        gameOver();
    });

    // Chatting 영역 시작
    $(document).on('keydown', 'div.publisher input', function(e){
        if(e.keyCode == 13 && !e.shiftKey) {
            e.preventDefault();
                        
            // 메시지 전송
            sendMessage();
            // 입력창 clear
            clearMsg();
            
        }
    });
    // 다른 사람이 메시지 전송시 받기
    bingoRoom.on('received', function(user_name, msg){
        $("#chat_list").append("<li class='list-group-item list-group-item-success'><span>"+ user_name + " : " + msg +"</span></li>");
        // 스크롤바 아래 고정
        $('div.chat_log').scrollTop($('div.chat_log').prop('scrollHeight'));
    });

    $('#send').click(function(e) {
        e.preventDefault();

        sendMessage();
    });

    // 메시지 전송
    function sendMessage() {
        var msg = $('#msg').val();
        
        if(msg == "") return;

        console.log(user_name, msg, roomIdx)
        
        bingoRoom.emit('send', { user_name, msg, roomIdx });

        $("#chat_list").append("<li class='list-group-item list-group-item-success me'><span>" + user_name + "(나) : " + msg +"</span></li>");
        
        // 스크롤바 아래 고정
        $('div.chat_log').scrollTop($('div.chat_log').prop('scrollHeight'));
        clearMsg();
    };

    // 메시지 입력창 초기화
    function clearMsg(){
        $("#msg").val("");
    };

</script>
</html>